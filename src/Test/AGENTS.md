# AGENTS（Test/docs）

このディレクトリは「テストの考え方や設計方法」を学習・記録する場です。ここでのテストは実装技術だけでなく、設計判断（抽象化・カプセル化・依存の向き・モジュール境界）を明確にするための設計活動として扱います。

## スコープと前提
- スコープ: `src/Test/` 配下の設計メモ・用語集・小さなコード例・シナリオ。
- 方針: リポジトリの AGENTS 方針に従い、日本語で、設計の視点を重視。過剰実装を避け、学習の焦点（設計判断）を明確化する。
- 依存: Docker は不要。ローカル実行前提。必要なら最小限のスクリプトを追加。

## 学習の思考手順（この順で短く回す）
1) 問題の言い換え: 何を保証/検出/観測したいかを一文で表す。
2) 用語定義（ユビキタス言語）: SUT、テストダブル、境界などの語を揃える。
3) モデル候補: 値オブジェクト/エンティティ/ドメインサービスのどれで表すか仮説化。
4) 境界/ルール: モジュール境界、依存の向き、入出力契約、可視性（公開/非公開）。
5) 例外/不変条件: 破れない条件と違反時の扱い（例外・失敗）を定義。
6) 最小実装: 単一ケースから始め、設計意図をコメントで記録。

## テスト設計の観点（設計をテストに落とす）
- ピラミッド: 単体（多）→ 統合（中）→ E2E（少）。コストと検出力のトレードオフを明示。
- 依存の向き: 上位ポリシー（ドメイン）→ 下位詳細（外部I/O）。テストは詳細に依存せずポート越しに観測。
- ポート/アダプタ: 外部境界はポート（抽象）で表し、テストではフェイク/スタブで置換。
- シーム設計: 置換点（時間、乱数、外部API、DB、現在日時）を注入可能にして決定性を確保。
- 観測可能性: 公開APIの出力/状態変化/ドメインイベントを観測。内部実装には過度に耽溺しない。
- ドメインとの整合: 集約の不変条件をテストで守る（作れる/壊れない/直せる）。

## テストダブル選択基準（最小驚き）
- ダミー: 使わないが引数を埋めたい時。
- スタブ: 入力→固定出力で分岐を進めたい時。
- フェイク: 簡易実装で現実的振る舞いを再現したい時（例: メモリ内リポジトリ）。
- スパイ: 呼び出しを観測したい時（副作用検証）。
- モック: 振る舞い期待を先に定義したい時（過度依存は避ける）。

## BDDシナリオ雛形（例）
```
機能: 入金により残高が更新される
  シナリオ: 正常な金額で入金
    前提 口座残高が 1,000 円
    もし 500 円を入金
    ならば 残高は 1,500 円
    かつ ドメインイベント「入金完了」が発行される
```

## 最小コード例（値オブジェクトとシーム）
以下は「金額」を値オブジェクトで表し、不変条件をテストしやすくする最小例です。時間シームを注入して決定性を得ます。

```ts
// 金額は負にならないという不変条件を内包。テストは公開APIのみ観測。
export class Money {
  private constructor(private readonly value: number) {}
  static of(value: number): Money {
    if (!Number.isInteger(value) || value < 0) throw new Error("invalid");
    return new Money(value);
  }
  add(other: Money): Money { return new Money(this.value + other.value); }
  toNumber(): number { return this.value; }
}

// 時間シーム（決定性のため注入）
export interface Clock { now(): Date; }
export class SystemClock implements Clock { now(): Date { return new Date(); } }

// ドメインサービスは副作用を持たず、ポート越しに外部へ。
export class DepositService {
  constructor(private readonly clock: Clock) {}
  deposit(balance: Money, amount: Money) {
    const newBalance = balance.add(amount);
    return { newBalance, occurredAt: this.clock.now() };
  }
}
```

設計意図:
- 不変条件（非負）を `Money` 内へカプセル化し、テストは生成/加算で検証。
- 現在時刻は `Clock` ポートで注入し、テストでは固定時刻のフェイクで決定化。
- サービスは純粋に計算して結果（新残高 + 事実）を返す。

## 期待アウトプット（このディレクトリで積むもの）
- ドメイン用語集（テスト用語・ユビキタス言語）
- 境界づけられたコンテキストの簡易図/テキスト（テスト観点での境界）
- 集約テスト設計メモ（不変条件・ルール・操作）
- BDDシナリオ（事例ベース）
- 小さなコード例（値オブジェクト/エンティティ/ドメインサービス/ポート）

## ルール/チェックリスト
- 公開APIで検証し、内部実装詳細への過度なアサーションは避ける。
- テストに現れる語は用語集へ追加し、名前の衝突を解消する。
- シームを用意できない場合は責務を分割し、境界を再設計する。
- 最小ケースから始め、失敗例（例外/境界値）を一つずつ増やす。
- 過剰なモック化や E2E 依存を避け、コスト/検出力のバランスを維持。
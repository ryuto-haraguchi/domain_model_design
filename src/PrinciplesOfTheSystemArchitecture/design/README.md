# 4層アーキテクチャ設計

## 概要

`db.tsx`のデータを元に、レイヤードアーキテクチャに基づいた4層構造を実装しました。

## アーキテクチャ構造

```
design/
├── domain/                    # ドメインモデル層
│   ├── DomainError.ts         # ドメインエラー
│   ├── entities/              # エンティティ
│   │   ├── User.ts
│   │   ├── Item.ts
│   │   └── Order.ts
│   └── valueObjects/          # 値オブジェクト
│       ├── Email.ts
│       ├── Price.ts
│       └── Quantity.ts
├── repository/                # リポジトリ層
│   ├── IUserRepository.ts     # インターフェース
│   ├── IItemRepository.ts
│   ├── IOrderRepository.ts
│   └── impl/                   # 実装
│       ├── InMemoryUserRepository.ts
│       ├── InMemoryItemRepository.ts
│       └── InMemoryOrderRepository.ts
├── application/               # アプリケーション層
│   ├── RegisterUserUseCase.ts
│   ├── GetUsersUseCase.ts
│   ├── CreateOrderUseCase.ts
│   └── GetUserOrdersUseCase.ts
├── presentation/              # プレゼンテーション層
│   ├── UserController.ts
│   └── OrderController.ts
├── ApplicationFactory.ts      # 依存関係の注入
└── index.ts                    # エントリーポイント
```

## 各層の責務

### 1. ドメインモデル層（domain/）

**責務**: ビジネスロジックと不変条件の表現

- **エンティティ**: 識別子を持つドメインオブジェクト（User, Item, Order）
- **値オブジェクト**: 不変条件を持つ値（Email, Price, Quantity）
- **設計意図**:
  - 業務ルールを型で表現し、不変条件を保証
  - プリミティブ型の代わりに値オブジェクトを使用して、バリデーションを一箇所に集約

### 2. リポジトリ層（repository/）

**責務**: データアクセスの抽象化

- **インターフェース**: ドメインモデル層に依存（依存方向の逆転）
- **実装**: インメモリリポジトリ（実際のプロダクションではDB接続実装に置き換え可能）
- **設計意図**:
  - ドメイン層とインフラ層の分離
  - プリミティブ ↔ ドメインオブジェクトの変換を担当

### 3. アプリケーション層（application/）

**責務**: ユースケースの実現

- **ユースケース**: ビジネスプロセスの実行順序を管理
- **設計意図**:
  - 複数のリポジトリを協調させてユースケースを実現
  - トランザクション境界の管理
  - ドメインロジックは呼び出すだけで、実装は持たない

### 4. プレゼンテーション層（presentation/）

**責務**: 外部インターフェースの処理

- **コントローラー**: HTTPリクエスト/レスポンスの変換
- **設計意図**:
  - 薄い層として、アプリケーション層のユースケースを呼び出すだけ
  - エラーハンドリングとレスポンス形式の統一
  - 実際のHTTPサーバーでは、ルーティングハンドラーになる

## 依存関係

```
プレゼンテーション層
    ↓
アプリケーション層
    ↓
リポジトリ層（インターフェース）
    ↓
ドメインモデル層
```

**設計原則**:
- 依存関係は一方向（外側から内側へ）
- リポジトリはインターフェースに依存（依存方向の逆転）
- 各層は内側の層にのみ依存

## 実行方法

```bash
# TypeScriptのコンパイルと実行
npx tsx src/PrinciplesOfTheSystemArchitecture/design/index.ts
```

## 設計のポイント

1. **値オブジェクトによる不変条件の保証**
   - Email: 形式チェック
   - Price: 0以上
   - Quantity: 1以上の整数

2. **エンティティの不変性**
   - 状態変更は新しいインスタンスを返す
   - updatedAtを自動更新

3. **リポジトリパターン**
   - インターフェースと実装を分離
   - テスト容易性の向上

4. **ユースケースの明確化**
   - 各ユースケースは単一の責務を持つ
   - ビジネスロジックの流れが明確

5. **エラーハンドリング**
   - DomainErrorでドメインエラーを表現
   - プレゼンテーション層で統一的なエラーレスポンス

## 次の検討観点

- 認証・認可の追加（アプリケーション層の横断的関心事）
- トランザクション管理の実装
- イベントソーシングやCQRSパターンの検討
- より詳細なドメインロジックの追加（例: 在庫管理、割引計算）
- 実際のDB接続実装への置き換え
